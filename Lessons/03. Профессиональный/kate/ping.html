<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ping-pong DOM</title>
</head>
<body>

<style>
    .gameDiv{
        background-color:lightsteelblue;
        border: 1px solid black;
        position: relative;
    }
    .startDiv{
        margin: 10px;
    }
    #racket1{
        background-color: green;
        position: absolute;
    }
    #racket2{
        background-color: blue;
        position: absolute;
    }
    #ball{
        background-color: red;
        border-radius: 50%;
        position: absolute;

    }
    #score{
        margin-left: 215px;
        font-size: 45px;
    }
    .startBtn{
        width: 100px;
        height: 30px;
        font-size: 20px;
    }
    #countdown{
        font-size: 45px;
        color: red;
        margin-left: 200px;
    }


</style>
<script>
    // создание фона игры и переменных

    let startDiv = document.createElement('div'); //стартовый див
    startDiv.className = 'startDiv';
    document.body.append(startDiv);

    let startBtn = document.createElement('button');//кнопка старт
    startBtn.className = 'startBtn';
    startBtn.textContent = 'Старт!';
    startDiv.append(startBtn);
    startBtn.addEventListener('click',startGame);

    let score = document.createElement('span');//табло
    let leftPlayer = 0;
    let rightPlayer = 0;
    score.id = 'score';
    score.textContent = `${leftPlayer}:${rightPlayer}`;
    startDiv.append(score);

    let countdown = document.createElement('span');// обратный отсчет
    countdown.id = 'countdown';
    countdown.textContent = '';
    startDiv.append(countdown);

    let gameDiv = document.createElement('div');//див самой игры
    gameDiv.className = 'gameDiv';
    let gameWidth = 700;
    let gameHeight = 400;
    gameDiv.style.width = `${gameWidth}px`;
    gameDiv.style.height = `${gameHeight}px`;
    document.body.append(gameDiv);

    var racket1 = document.createElement('div'); //ракетки
    var racket2 = document.createElement('div');
    racket1.id = 'racket1';
    racket2.id = 'racket2';
    let racketHeight = gameHeight/3;
    let racketWidth = 15;
    racket1.style.cssText = `width:${racketWidth}px;
                                 height:${racketHeight}px;`;
    racket2.style.cssText = `width:${racketWidth}px;
                                 height:${racketHeight}px;`;
    gameDiv.append(racket1);
    gameDiv.append(racket2);
    //РАКЕТКА 1 левая
    var r1 = {
        posX : 0,
        posY : gameHeight/2 - racketHeight/2,
        speedY : 10,
        update: function(){
            var racketElem1 = document.getElementById('racket1');
            racketElem1.style.left=this.posX+"px";
            racketElem1.style.top=this.posY+"px";
        }
    }
    r1.update();
    // РАКЕТКА 2 правая
    var r2 = {
        posX : gameWidth - racketWidth,
        posY : gameHeight/2 - racketHeight/2,
        speedY : 10,
        update: function(){
            var racketElem2 = document.getElementById('racket2');
            racketElem2.style.left=this.posX+"px";
            racketElem2.style.top=this.posY+"px";
        }
    }
    r2.update();
    //МЯЧ
    var ball = document.createElement('div'); //добавили мяч
    ball.id ='ball';
    ball.style.cssText = `width:${gameWidth/15}px;
                             height:${gameWidth/15}px;`;
    gameDiv.append(ball);

    var ballH={ //объект значений для мяча
        posX : gameWidth/2 - ball.offsetWidth/2,
        posY : gameHeight/2 - ball.offsetHeight/2,
        speedX : 3,
        speedY : 1,


        update : function() {// забираем мяч и присваеваем ему значения из массива
            var ballElem=document.getElementById('ball');
            ballElem.style.left=this.posX+"px";
            ballElem.style.top=this.posY+"px";
        },
        random : function(){
            this.speedX = randomSpeed()*3;
        }
    }
    ballH.update();
    ballH.random();
    var idAnim;
    function start(){//  запускается по кнопке старт
        idAnim = requestAnimationFrame(startGame);
    }
    let timer;
    function startGame(){
        ballH.posX += ballH.speedX; // мяч летит вправо
        //удар мяча о правую ракетку ( если мяч по у> ракетки по у, но меньше ракетки по у+ ее ширина И мяч по х+ширина мяча> ширины поля-ширина ракетки)
        if((ballH.posY>r2.posY) && (ballH.posY<r2.posY+racketHeight) && (ballH.posX + ball.offsetWidth) >= gameWidth-racketWidth){
            ballH.speedX =- ballH.speedX;
            ballH.posX = gameWidth - ball.offsetWidth - racketWidth;


        }
        //удар о левую ракетку()
        if((ballH.posY>r1.posY) && (ballH.posY<r1.posY+racketHeight) && (ballH.posX ) <= racketWidth){
            ballH.speedX =- ballH.speedX;
            ballH.posX = racketWidth;

        }
        // если мяч вылетел за правую стену
        if(ballH.posX + ball.offsetWidth >= gameWidth){
            leftPlayer++;
            score.textContent = `${leftPlayer}:${rightPlayer}`;
            if(leftPlayer>=5){
                cancelAnimationFrame(idAnim);
                alert('Игра завершена!')
            }
            else{
                timer = setInterval(function(){
                    handleTimer(count);
                },1000);
            }

        }


/* +++++++++++++  эту часть кода ниже чем левая ракетка  +++++++++++++ */
        // else {
        //     ballH.update();
        //     idAnim = requestAnimationFrame(startGame);
        // }
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


        // если мяч вылетел за левую стену
         else if (ballH.posX<=0){ /* +++++++++++++++++++  else if вместо if   +++++++++++++++++++ */
            console.log('левая сторона')

            rightPlayer++;
            score.textContent = `${leftPlayer}:${rightPlayer}`;
            if(rightPlayer>=5){
                cancelAnimationFrame(idAnim);
                alert('Игра завершена!')
            }
            else{
                timer = setInterval(function(){
                    handleTimer(count);
                },1000);

            }
        }


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
        else{
            ballH.update();
            idAnim = requestAnimationFrame(startGame);
        }
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


        ballH.posY += ballH.speedY;
        // если мяч ударился о пол и потолок
        if(ballH.posY + ball.offsetHeight>= gameHeight){
            ballH.speedY =- ballH.speedY;
            ballH.posY = gameHeight - ball.offsetHeight;

        }
        if(ballH.posY<=0){
            ballH.posY = 0;
            ballH.speedY =- ballH.speedY;

        }



    }

    //движение ракеток
    document.addEventListener('keydown',function(event){
        console.log(event.key + " " + event.location);
        switch(event.key){
            case 'ArrowUp':
                moveUpR2();
                break;
            case 'ArrowDown':
                moveDownR2();
                break;
            case 'Shift':
                moveUpR1();
                break;
            case 'Control':
                moveDownR1();
                break;
        }
    });
    function moveUpR2(){
        r2.posY -= r2.speedY;
        if(r2.posY <= 0){
            r2.posY = 0;
        }
        r2.update();
    }
    function moveDownR2(){
        r2.posY += r2.speedY;
        if(racket2.offsetHeight + r2.posY>= gameHeight){
            r2.posY = gameHeight - racket2.offsetHeight;
        }
        r2.update();
    }
    function moveUpR1(){
        r1.posY -= r1.speedY;
        if(r1.posY <= 0){
            r1.posY = 0;
        }
        r1.update();
    }
    function moveDownR1(){
        r1.posY += r1.speedY;
        if(racket1.offsetHeight + r1.posY>= gameHeight){
            r1.posY = gameHeight - racket1.offsetHeight;
        }
        r1.update();
    }
    // перезапуск игры
    var count = 3;
    function handleTimer(){
        countdown.textContent = count;
        count--;
        if(count===-1){
            countdown.textContent = '';
            restart();
            clearInterval(timer);
            count = 3;
        }
    }
    function restart(){
        ballH.posX = gameWidth/2 - ball.offsetWidth/2;
        ballH.posY = gameHeight/2 - ball.offsetHeight/2;
        idAnim = requestAnimationFrame(startGame);

    }
    function randomSpeed() { //рандомный вылет мяча
        let x = Math.random();
        if (x < 0.5) x = -1;
        else x = 1;
        return x;
    }
</script>
</body>
</html>
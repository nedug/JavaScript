<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
</head>
<body>


Ваше имя: <input type='text' id='IName'><br />
Текст сообщения:<br />
<input type='text' id='IMess' style='width: 300px'><br />
<input type='button' value='отправить' onclick='sendMessage()'>
<input type='button' value='освежить' onclick='refreshMessages()'><br />
Окно чата:<br />
<div id='IChat' style='border: solid red 1px; overflow-x: hidden'></div>

<script src="http://fe.it-academy.by/JQ/jquery.js"></script>
<script>

    "use strict";

    var ajaxHandlerScript="https://fe.it-academy.by/AjaxStringStorage2.php";
    var messages; // элемент массива - {name:'Иванов',mess:'Привет'};
    var updatePassword;
    var stringName='SASHA1_CHAT_MESSAGES';

    // показывает все сообщения из messages на страницу
    function showMessages() {
        var str='';
        for ( var m=0; m<messages.length; m++ ) {
            var message=messages[m];
            str+="<b>"+escapeHTML(message.name)+":</b> "
                +escapeHTML(message.mess)+"<br />";
        }
        document.getElementById('IChat').innerHTML=str;
    }

    function escapeHTML(text) {
        if ( !text )
            return text;
        text=text.toString()
            .split("&").join("&amp;")
            .split("<").join("&lt;")
            .split(">").join("&gt;")
            .split('"').join("&quot;")
            .split("'").join("&#039;");
        return text;
    }

    // получает сообщения с сервера и потом показывает
    function refreshMessages() {
        $.ajax( {
                url : ajaxHandlerScript,
                type : 'POST', dataType:'json',
                data : { f : 'READ', n : stringName },
                cache : false,
                success : readReady,
                error : errorHandler
            }
        );
    }

    function readReady(callresult) { // сообщения получены - показывает
        if ( callresult.error!=undefined )
            alert(callresult.error);
        else {
            messages=[];
            if ( callresult.result!="" ) { // либо строка пустая - сообщений нет
                // либо в строке - JSON-представление массива сообщений
                messages=JSON.parse(callresult.result);
                // вдруг кто-то сохранил мусор вместо LOKTEV_CHAT_MESSAGES?
                if ( !Array.isArray(messages) )
                    messages=[];
            }
            showMessages();
        }
    }

    // получает сообщения с сервера, добавляет новое,
    // показывает и сохраняет на сервере
    function sendMessage() {
        updatePassword=Math.random();
        $.ajax( {
                url : ajaxHandlerScript,
                type : 'POST', dataType:'json',
                data : { f : 'LOCKGET', n : stringName,
                    p : updatePassword },
                cache : false,
                success : lockGetReady,
                error : errorHandler
            }
        );
    }

    // сообщения получены, добавляет, показывает, сохраняет
    function lockGetReady(callresult) {
        if ( callresult.error!=undefined )
            alert(callresult.error);
        else {
            messages=[];
            if ( callresult.result!="" ) { // либо строка пустая - сообщений нет
                // либо в строке - JSON-представление массива сообщений
                messages=JSON.parse(callresult.result);
                // вдруг кто-то сохранил мусор вместо LOKTEV_CHAT_MESSAGES?
                if ( !Array.isArray(messages) )
                    messages=[];
            }

            var senderName=document.getElementById('IName').value;
            var message=document.getElementById('IMess').value;
            messages.push( { name:senderName, mess:message } );
            if ( messages.length>10 )
                messages=messages.slice(messages.length-10);

            showMessages();

            $.ajax( {
                    url : ajaxHandlerScript,
                    type : 'POST', dataType:'json',
                    data : { f : 'UPDATE', n : stringName,
                        v : JSON.stringify(messages), p : updatePassword },
                    cache : false,
                    success : updateReady,
                    error : errorHandler
                }
            );
        }
    }

    // сообщения вместе с новым сохранены на сервере
    function updateReady(callresult) {
        if ( callresult.error!=undefined )
            alert(callresult.error);
    }

    function errorHandler(jqXHR,statusStr,errorStr) {
        alert(statusStr+' '+errorStr);
    }

    refreshMessages();

</script>



</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
</head>
<body>

Ваше имя: <input type='text' id='IName'><br />
Текст сообщения:<br />
<input type='text' id='IMess' style='width: 300px'><br />
<input type='button' value='отправить' onclick='sendMessage()'>
<input type='button' value='освежить' onclick='refreshMessages()'><br />
Окно чата:<br />
<div id='IChat' style='border: solid red 1px; overflow-x: hidden'></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>


<script>

    let ajaxHandlerScript = "https://fe.it-academy.by/AjaxStringStorage2.php"; /* Серверный скрипт; Сервис AjaxStringStorage2 предназначен для сохранения в базе данных и получения из базы данных */
    let messages;
    let updatePassword;
    let stringName = 'SASHA_RUS_BISE';


    // показывает все сообщения из messages на страницу
    function showMessages() {
        var str='';
        for ( var m=0; m<messages.length; m++ ) {
            var message=messages[m];
            str+="<b>"+escapeHTML(message.name)+":</b> "
                +escapeHTML(message.mess)+"<br />";
        }
        document.getElementById('IChat').innerHTML=str;
    }

    function escapeHTML(text) {
        if ( !text )
            return text;
        text=text.toString()
            .split("&").join("&amp;")
            .split("<").join("&lt;")
            .split(">").join("&gt;")
            .split('"').join("&quot;")
            .split("'").join("&#039;");
        return text;
    }

    // получает сообщения с сервера и потом показывает
    function refreshMessages() {
        $.ajax( {
                url : ajaxHandlerScript,
                type : 'POST', dataType:'json',
                data : { f : 'READ', n : stringName },
                cache : false,
                success : readReady,
                error : errorHandler
            }
        );
    }

    function readReady(callresult) { // сообщения получены - показывает
        if ( callresult.error!=undefined )
            alert(callresult.error);
        else {
            messages=[];
            if ( callresult.result!="" ) { // либо строка пустая - сообщений нет
                // либо в строке - JSON-представление массива сообщений
                messages=JSON.parse(callresult.result);
                // вдруг кто-то сохранил мусор вместо LOKTEV_CHAT_MESSAGES?
                if ( !Array.isArray(messages) )
                    messages=[];
            }
            showMessages();
        }
    }

    // получает сообщения с сервера, добавляет новое,
    // показывает и сохраняет на сервере
    function sendMessage() {
        updatePassword=Math.random();
        $.ajax( {
                url : ajaxHandlerScript,
                type : 'POST', dataType:'json',
                data : { f : 'LOCKGET', n : stringName,
                    p : updatePassword },
                cache : false,
                success : lockGetReady,
                error : errorHandler
            }
        );
    }

    // сообщения получены, добавляет, показывает, сохраняет
    function lockGetReady(callresult) {
        if ( callresult.error!=undefined )
            alert(callresult.error);
        else {
            messages=[];
            if ( callresult.result!="" ) { // либо строка пустая - сообщений нет
                // либо в строке - JSON-представление массива сообщений
                messages=JSON.parse(callresult.result);
                // вдруг кто-то сохранил мусор вместо LOKTEV_CHAT_MESSAGES?
                if ( !Array.isArray(messages) )
                    messages=[];
            }

            // var senderName=document.getElementById('IName').value;
            // var message=document.getElementById('IMess').value;

            var senderName = 'advice';
            var message = ['https://www.youtube.com/embed/PBR-Yev5vO8',
                'https://www.youtube.com/embed/2DQxagQZTLg',
                'https://www.youtube.com/embed/lOx4HgqchUw',
                'https://www.youtube.com/embed/a15y8r382Cw',
                'https://www.youtube.com/embed/scEVwgfn1_A',
                'https://www.youtube.com/embed/tM-G_VVIj9M',
                'https://www.youtube.com/embed/nXPoii1SwqU',
                'https://www.youtube.com/embed/EfN9VpZNeD0',
                'https://www.youtube.com/embed/3CPrJmZahJE',
                'https://www.youtube.com/embed/nKVeRDiZaes',
            ]


            messages.push( { name:senderName, mess:message } );
            if ( messages.length>10 )
                messages=messages.slice(messages.length-10);

            showMessages();

            $.ajax( {
                    url : ajaxHandlerScript,
                    type : 'POST', dataType:'json',
                    data : { f : 'UPDATE', n : stringName,
                        v : JSON.stringify(messages), p : updatePassword },
                    cache : false,
                    success : updateReady,
                    error : errorHandler
                }
            );
        }
    }

    // сообщения вместе с новым сохранены на сервере
    function updateReady(callresult) {
        if ( callresult.error!=undefined )
            alert(callresult.error);
    }

    function errorHandler(jqXHR,statusStr,errorStr) {
        alert(statusStr+' '+errorStr);
    }

    refreshMessages();






</script>

</body>
</html>